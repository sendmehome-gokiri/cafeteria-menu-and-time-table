<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
  <h1>ìš°ë¦¬ í•™êµ ê¸‰ì‹/ì‹œê°„í‘œ ì¡°íšŒ</h1>

  <input type="radio" name="schoolLevel" value="ì¤‘í•™êµ" checked /> ì¤‘í•™êµ
  <input type="radio" name="schoolLevel" value="ê³ ë“±í•™êµ" /> ê³ ë“±í•™êµ<br/>

  <input type="text" id="schoolName" placeholder="í•™êµ ì´ë¦„ ì…ë ¥" />
  <input type="date" id="targetDate" />
  <input type="number" id="grade" placeholder="í•™ë…„ (ì˜ˆ: 1)" min="1" />
  <input type="number" id="classNum" placeholder="ë°˜ (ì˜ˆ: 1)" min="1" />
  <button onclick="getMealAndTimetable()">ì¡°íšŒ</button>

  <div id="mealResult"></div>
  
  <script>
      const API_KEYS = {
    'ì¤‘í•™êµ': '4f65f5cdce8c4124aa27ca3ef6be7510',
    'ê³ ë“±í•™êµ': 'c1e57e7d0a99471e92ca9c0b08841865'
	  };

  async function getMealAndTimetable() {
    const schoolLevel = document.querySelector('input[name="schoolLevel"]:checked').value;
    const API_KEY = API_KEYS[schoolLevel];

    const schoolName = document.querySelector('#schoolName').value.trim();
    const date = document.querySelector('#targetDate').value.replaceAll('-', '');
    const grade = document.querySelector('#grade').value.trim();
    const classNum = document.querySelector('#classNum').value.trim();

    if (!schoolName || !date || !grade || !classNum) {
      document.querySelector('#mealResult').innerText = 'ëª¨ë“  ì…ë ¥ê°’(í•™êµ, ë‚ ì§œ, í•™ë…„, ë°˜)ì„ ì±„ì›Œì£¼ì„¸ìš”.';
      return;
    }

    // 1. í•™êµ ì •ë³´ ì¡°íšŒ
    const schoolInfoUrl = `https://open.neis.go.kr/hub/schoolInfo?KEY=e53aa95cbb5c4a4c94b044793dd453f7&Type=json&SCHUL_NM=${encodeURIComponent(schoolName)}`;
    const infoRes = await fetch(schoolInfoUrl);
    const infoData = await infoRes.json();

    if (!infoData.schoolInfo) {
      document.querySelector('#mealResult').innerText = 'í•™êµë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.';
      return;
    }

    const schoolCode = infoData.schoolInfo[1].row[0].SD_SCHUL_CODE;
    const eduCode = infoData.schoolInfo[1].row[0].ATPT_OFCDC_SC_CODE;
    const schoolKind = infoData.schoolInfo[1].row[0].SCHUL_KND_SC_NM;

    // 2. ê¸‰ì‹ ì¡°íšŒ
    const mealUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=e53aa95cbb5c4a4c94b044793dd453f7&Type=json&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_YMD=${date}`;
    const mealRes = await fetch(mealUrl);
    const mealData = await mealRes.json();

    let mealText = 'ğŸ½ ê¸‰ì‹ ë©”ë‰´:\n';

    if (mealData.mealServiceDietInfo) {
      const dishList = mealData.mealServiceDietInfo[1].row;
      const groupedMeals = {
        'ì¡°ì‹': [],
        'ì¤‘ì‹': [],
        'ì„ì‹': []
      };

      dishList.forEach(meal => {
        const mealType = meal.MMEAL_SC_NM;
        const menu = meal.DDISH_NM.replace(/<br\/>/g, '\n');
        groupedMeals[mealType].push(menu);
      });

      for (const [type, menus] of Object.entries(groupedMeals)) {
        if (menus.length > 0) {
          mealText += `\nğŸ± [${type}]\n${menus.join('\n')}\n`;
        }
      }
    } else {
      mealText += 'í•´ë‹¹ ë‚ ì§œì˜ ê¸‰ì‹ ì •ë³´ê°€ ì—†ì–´ìš”.\n';
    }

    // 3. ì‹œê°„í‘œ ì¡°íšŒ
    const timetableEndpoint = schoolKind.includes('ê³ ') ? 'hisTimetable' : schoolKind.includes('ì¤‘') ? 'misTimetable' : 'elsTimetable';
    const timeUrl = `https://open.neis.go.kr/hub/${timetableEndpoint}?KEY=${API_KEY}&Type=json&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&ALL_TI_YMD=${date}&GRADE=${grade}&CLASS_NM=${classNum}`;
    const timeRes = await fetch(timeUrl);
    const timeData = await timeRes.json();

    let timetableText = '\nğŸ“š ì‹œê°„í‘œ:\n';

    if (timeData[timetableEndpoint]) {
      const classes = timeData[timetableEndpoint][1].row;

      classes.forEach(cls => {
        timetableText += `${cls.PERIO}êµì‹œ: ${cls.ITRT_CNTNT}\n`;
      });
    } else {
      timetableText += 'í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„í‘œ ì •ë³´ê°€ ì—†ì–´ìš”.\n';
    }

    document.querySelector('#mealResult').innerText = mealText + '\n' + timetableText;
  }

  </script>

</body>
</html>